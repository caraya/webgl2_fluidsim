"use strict";var e=document.querySelector("#fluidsim_canvas");const v=e.getContext("webgl2");v.getExtension("EXT_color_buffer_float");let t={i:1,t:.5,o:"dye",v:.1,u:.99,l:.99,p:128,_:1024},o,r,c,s,u;function i(e){return o<1?{width:e,height:Math.round(e/o)}:{width:Math.round(e*o),height:e}}function x(){var e=v.canvas.clientWidth,n=v.canvas.clientHeight;if(o=v.canvas.clientWidth/v.canvas.clientHeight,v.canvas.width!==e||v.canvas.height!==n)return v.canvas.width=e,v.canvas.height=n,e=i(t.p),n=i(t._),r=e.width,c=e.height,s=n.width,u=n.height,1}x();let l=v.createVertexArray(),a=v.createVertexArray();const p=0;function _(e,n,i,t,o,r,c){v.bindVertexArray(e);e=v.createBuffer();v.bindBuffer(v.ARRAY_BUFFER,e),v.bufferData(v.ARRAY_BUFFER,n,v.STATIC_DRAW),v.enableVertexAttribArray(p),v.vertexAttribPointer(p,i,t,o,r,c)}function f(){var e=1/r,n=1/c,e=new Float32Array([e-1,n-1,1-e,1-n,1-e,n-1,e-1,n-1,e-1,1-n,1-e,1-n]),n=(_(l,e,2,v.FLOAT,!1,0,0),new Float32Array([-1,-1,1,1,1,-1,-1,-1,-1,1,1,1]));_(a,n,2,v.FLOAT,!1,0,0)}f();var n=`#version 300 es
in vec2 a_position;
out vec2 v_position;

void main() {
  v_position = a_position * 0.5 + 0.5;
  gl_Position = vec4(a_position, 0, 1);
}`;function h(e,n,i){n=e.createShader(n);return e.shaderSource(n,i),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)?n:(console.error(e.getShaderInfoLog(n)),e.deleteShader(n),null)}function m(e,n){var i,t,e=h(v,v.VERTEX_SHADER,e),n=h(v,v.FRAGMENT_SHADER,n),e=(i=v,e=e,n=n,t=i.createProgram(),i.attachShader(t,e),i.attachShader(t,n),i.linkProgram(t),i.getProgramParameter(t,i.LINK_STATUS)?t:(console.error(i.getProgramInfoLog(t)),i.deleteProgram(t),null)),n=function(n,i){var t={},o=n.getProgramParameter(i,n.ACTIVE_UNIFORMS);for(let e=0;e<o;++e){var r=n.getActiveUniform(i,e);t[r.name]=n.getUniformLocation(i,r.name)}return t}(v,e);return v.bindAttribLocation(e,p,"a_position"),{h:e,m:n}}const d=m(n,`#version 300 es
precision highp float;

in vec2 v_position;
uniform sampler2D u_v;
uniform sampler2D u_x;
uniform float u_dt;
uniform float u_dissipation;
out vec4 res;

vec4 bilerp(sampler2D tex, vec2 x_norm, vec2 size) {
  vec2 x = x_norm * size;
  vec2 fx = fract(x);
  ivec2 ix = ivec2(floor(x));

  vec4 x00 = texelFetch(tex, ix + ivec2(0,0), 0);
  vec4 x01 = texelFetch(tex, ix + ivec2(0,1), 0);
  vec4 x10 = texelFetch(tex, ix + ivec2(1,0), 0);
  vec4 x11 = texelFetch(tex, ix + ivec2(1,1), 0);

  return mix(mix(x00, x10, fx.x), mix(x01, x11, fx.x), fx.y);
}

void main() {
  vec2 size_v = vec2(textureSize(u_v, 0));
  vec2 size_x = vec2(textureSize(u_x, 0));
  vec2 aspect_ratio = vec2(size_x.x / size_x.y, 1.0);
  vec2 normalized_pos = floor(gl_FragCoord.xy) / size_x;
  vec2 prev = normalized_pos - u_dt * bilerp(u_v, normalized_pos, size_v).xy / aspect_ratio; 
  res = u_dissipation * bilerp(u_x, prev, size_x);
}`),b=m(n,"#version 300 es\nprecision highp float;\n\nuniform sampler2D u_x;\nuniform sampler2D u_b;\nuniform float u_alpha;\nuniform float u_beta;\nout vec4 res;\n\n\nstruct Neighbors {\n  vec4 l;\n  vec4 r;\n  vec4 t;\n  vec4 b;\n  vec4 c;\n};\n\nNeighbors tex_neighbors(sampler2D tex, ivec2 pos) {\n  vec4 b = texelFetch(tex, pos - ivec2(0, 1), 0);\n  vec4 t = texelFetch(tex, pos + ivec2(0, 1), 0);\n  vec4 l = texelFetch(tex, pos - ivec2(1, 0), 0);\n  vec4 r = texelFetch(tex, pos + ivec2(1, 0), 0);\n  vec4 c = texelFetch(tex, pos, 0);\n  return Neighbors(l, r, t, b, c);\n}\n\nvoid main() {\n  ivec2 pos = ivec2(gl_FragCoord.xy); \n  Neighbors n = tex_neighbors(u_x, pos);\n  vec4 b = texelFetch(u_b, pos, 0);\n  res = (n.b + n.t + n.l + n.r + u_alpha * b) / u_beta;\n}"),g=m(n,"#version 300 es\nprecision highp float;\n\nuniform sampler2D u_v;\nuniform sampler2D u_p;\nout vec4 res;\n\n\nstruct Neighbors {\n  vec4 l;\n  vec4 r;\n  vec4 t;\n  vec4 b;\n  vec4 c;\n};\n\nNeighbors tex_neighbors(sampler2D tex, ivec2 pos) {\n  vec4 b = texelFetch(tex, pos - ivec2(0, 1), 0);\n  vec4 t = texelFetch(tex, pos + ivec2(0, 1), 0);\n  vec4 l = texelFetch(tex, pos - ivec2(1, 0), 0);\n  vec4 r = texelFetch(tex, pos + ivec2(1, 0), 0);\n  vec4 c = texelFetch(tex, pos, 0);\n  return Neighbors(l, r, t, b, c);\n}\n\nvoid main() {\n  ivec2 pos = ivec2(gl_FragCoord.xy); \n  Neighbors n = tex_neighbors(u_p, pos);\n\n  vec4 grad = vec4(n.r.x - n.l.x, n.t.x - n.b.x, 0, 0) / 2.;\n  vec4 init_v = texelFetch(u_v, pos, 0);\n  res = init_v - grad;\n}"),F=m(n,"#version 300 es\nprecision highp float;\n\nuniform sampler2D u_x;\nout vec4 res;\n\n\nstruct Neighbors {\n  vec4 l;\n  vec4 r;\n  vec4 t;\n  vec4 b;\n  vec4 c;\n};\n\nNeighbors tex_neighbors(sampler2D tex, ivec2 pos) {\n  vec4 b = texelFetch(tex, pos - ivec2(0, 1), 0);\n  vec4 t = texelFetch(tex, pos + ivec2(0, 1), 0);\n  vec4 l = texelFetch(tex, pos - ivec2(1, 0), 0);\n  vec4 r = texelFetch(tex, pos + ivec2(1, 0), 0);\n  vec4 c = texelFetch(tex, pos, 0);\n  return Neighbors(l, r, t, b, c);\n}\n\nvoid main() {\n  ivec2 pos = ivec2(gl_FragCoord.xy); \n  Neighbors n = tex_neighbors(u_x, pos);\n\n  float div = (n.r.x - n.l.x + n.t.y - n.b.y) / 2.;\n\n  res = vec4(div, 0, 0, 1);\n}"),y=m(n,`#version 300 es
precision highp float;

in vec2 v_position;
uniform sampler2D u_x;
uniform float u_alpha;
out vec4 res;

void main() {
  ivec2 pos = ivec2(gl_FragCoord.xy);
  ivec2 size = textureSize(u_x, 0);
  int l = 1 - min(pos.x, 1);
  int r = 1 - min(size.x - 1 - pos.x, 1);
  int b = 1 - min(pos.y, 1);
  int t = 1 - min(size.y - 1 - pos.y, 1);
  int border = min(l + r + b + t, 1);
  float coef = (border > 0) ? u_alpha : 1.0; 
  ivec2 dir = ivec2(l - r, b - t);
 
  res = coef  * texelFetch(u_x, pos + dir, 0);
}`),D=m(n,`#version 300 es
precision highp float;

in vec2 v_position;
uniform sampler2D u_x;
uniform float u_alpha;
out vec4 res;

void main() {
  res = u_alpha * texture(u_x, v_position);
}`),z=m(n,`#version 300 es
precision highp float;

in vec2 v_position;
uniform sampler2D u_x;
uniform vec2 u_point;
uniform vec3 u_value;
uniform float u_radius;
uniform float u_ratio;
out vec4 res;

void main() {
  vec4 init = texture(u_x, v_position);
  vec2 v = v_position - u_point;
  v.x *= u_ratio;
  vec3 force = exp(-dot(v,v)/u_radius) * u_value;

  res = vec4(init.xyz + force, 1.);
}`);function N(e,n,i,t,o,r){const c=v.createTexture(),s=(v.activeTexture(v.TEXTURE0),v.bindTexture(v.TEXTURE_2D,c),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,r),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,r),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE),v.texImage2D(v.TEXTURE_2D,0,i,e,n,0,t,o,null),v.createFramebuffer());return v.bindFramebuffer(v.FRAMEBUFFER,s),v.framebufferTexture2D(v.FRAMEBUFFER,v.COLOR_ATTACHMENT0,v.TEXTURE_2D,c,0),{g:c,F:s,bind:()=>{v.bindFramebuffer(v.FRAMEBUFFER,s),v.viewport(0,0,e,n)},D:e=>(v.activeTexture(v.TEXTURE0+e),v.bindTexture(v.TEXTURE_2D,c),e)}}function S(e,n,i,t,o,r){return{read:N(e,n,i,t,o,r),write:N(e,n,i,t,o,r),N:function(){var e=this.read;this.read=this.write,this.write=e}}}function R(e,n,i,t,o,r,c){n=N(n,i,t,o,r,c);return v.useProgram(D.h),v.uniform1i(D.m.u_x,e.D(0)),O(n,a,v.TRIANGLES,6),n}function I(e,n,i,t,o,r,c){var s=S(n,i,t,o,r,c);return s.read=R(e.read,n,i,t,o,r,c),s.write=R(e.write,n,i,t,o,r,c),s}let w=S(r,c,v.RG32F,v.RG,v.FLOAT,v.NEAREST),A=S(r,c,v.R32F,v.RED,v.FLOAT,v.NEAREST),E=N(r,c,v.R32F,v.RED,v.FLOAT,v.NEAREST),U=N(r,c,v.RG32F,v.RG,v.FLOAT,v.NEAREST),M=S(s,u,v.RGBA32F,v.RGBA,v.FLOAT,v.NEAREST);const L={g:null,F:null,bind:()=>{v.bindFramebuffer(v.FRAMEBUFFER,null),v.viewport(0,0,v.canvas.width,v.canvas.height)}};function O(e,n,i,t,o=!1){v.bindVertexArray(n),e.bind(),o&&(v.clearColor(0,0,0,1),v.clear(v.COLOR_BUFFER_BIT)),v.drawArrays(i,0,t)}function C(e,n){v.useProgram(y.h),v.uniform1i(y.m.u_x,e.read.D(0)),v.uniform1f(y.m.u_alpha,n),O(e.write,a,v.TRIANGLES,6),e.N()}let Y=0;requestAnimationFrame(function e(n){var i=(n-Y)/1e3,n=(Y=n,x()&&(f(),w=I(w,r,c,v.RG32F,v.RG,v.FLOAT,v.NEAREST),A=I(A,r,c,v.R32F,v.RED,v.FLOAT,v.NEAREST),M=I(M,s,u,v.RGBA32F,v.RGBA,v.FLOAT,v.NEAREST),E=N(r,c,v.R32F,v.RED,v.FLOAT,v.NEAREST),U=N(r,c,v.RG32F,v.RG,v.FLOAT,v.NEAREST)),T.forEach(e=>{v.useProgram(z.h),v.uniform1i(z.m.u_x,w.read.D(0)),v.uniform2fv(z.m.u_point,[e.x,e.y]),v.uniform3fv(z.m.u_value,[e.dx*o,e.dy,0].map(e=>20*e)),v.uniform1f(z.m.u_radius,t.v),v.uniform1f(z.m.u_ratio,o),O(w.write,l,v.TRIANGLES,6),w.N(),v.uniform1i(z.m.u_x,M.read.D(0)),v.uniform3fv(z.m.u_value,e.color.map(e=>.2*e)),O(M.write,l,v.TRIANGLES,6),M.N()}),i);C(w,-1),v.useProgram(d.h),v.uniform1i(d.m.u_v,0),v.uniform1i(d.m.u_x,w.read.D(0)),v.uniform1f(d.m.u_dt,n),v.uniform1f(d.m.u_dissipation,t.u),O(w.write,l,v.TRIANGLES,6),w.N(),C(M,0),v.useProgram(d.h),v.uniform1i(d.m.u_v,w.read.D(0)),v.uniform1i(d.m.u_x,M.read.D(1)),v.uniform1f(d.m.u_dt,n),v.uniform1f(d.m.u_dissipation,t.l),O(M.write,l,v.TRIANGLES,6),M.N(),C(w,-1),v.useProgram(b.h),n=1/(t.i*n),v.uniform1f(b.m.u_alpha,n),v.uniform1f(b.m.u_beta,4+n);for(let e=0;e<20;e++)v.uniform1i(b.m.u_x,w.read.D(0)),v.uniform1i(b.m.u_b,w.read.D(0)),O(w.write,l,v.TRIANGLES,6),w.N();C(w,-1),v.useProgram(F.h),v.uniform1i(F.m.u_x,w.read.D(0)),O(E,l,v.TRIANGLES,6),v.useProgram(D.h),v.uniform1i(D.m.u_x,A.read.D(0)),v.uniform1f(D.m.u_alpha,t.t),O(A.write,a,v.TRIANGLES,6),A.N();for(let e=0;e<50;e++)C(A,1),v.useProgram(b.h),v.uniform1i(b.m.u_b,E.D(0)),v.uniform1i(b.m.u_x,A.read.D(1)),v.uniform1f(b.m.u_alpha,-1),v.uniform1f(b.m.u_beta,4),O(A.write,l,v.TRIANGLES,6),A.N();C(w,-1),C(A,1),v.useProgram(g.h),v.uniform1i(g.m.u_p,A.read.D(0)),v.uniform1i(g.m.u_v,w.read.D(1)),O(w.write,l,v.TRIANGLES,6),w.N(),i=("velocity"==t.o?w:"pressure"==t.o?A:M).read,v.useProgram(D.h),v.uniform1i(D.m.u_x,i.D(0)),v.uniform1f(D.m.u_alpha,1),O(L,a,v.TRIANGLES,6),requestAnimationFrame(e)});const T=[];function q(e){return{id:e.pointerId,x:e.offsetX/v.canvas.clientWidth,y:1-e.offsetY/v.canvas.clientHeight,dx:0,dy:0,color:[Math.random(),Math.random(),Math.random()]}}e.addEventListener("pointerdown",e=>{T.push(q(e))}),e.addEventListener("pointerup",n=>{var e=T.findIndex(e=>e.id===n.pointerId);e<0||T.splice(e,1)}),e.addEventListener("pointermove",n=>{var e,i=T.findIndex(e=>e.id===n.pointerId);i<0||(e=q(n),T[i]=(i=T[i],(e=e).color=i.color,e.dx=e.x-i.x,e.dy=e.y-i.y,e))}),e.addEventListener("pointerout",n=>{var e=T.findIndex(e=>e.id===n.pointerId);e<0||T.splice(e,1)});var n=document.querySelector("#viscosity"),e=document.querySelector("#pressure"),V=document.querySelector("#radius"),X=document.querySelector("#velocity_dissipation"),j=document.querySelector("#density_dissipation"),k=document.querySelector("#display_radio");function P(e,n,i){return n*Math.pow(i/n,e)}const B=e=>P(e,1e-4,1e3),G=e=>P(e,1e-4,.01),H=e=>1-P(e,.001,.1),J=e=>1-P(e,.001,.1);t.i=B(n.value),t.t=e.value,t.v=G(V.value),t.u=H(X.value),t.l=J(j.value),n.addEventListener("input",e=>{t.i=B(e.target.value)}),e.addEventListener("input",e=>{t.t=e.target.value}),V.addEventListener("input",e=>{t.v=G(e.target.value)}),X.addEventListener("input",e=>{t.u=H(e.target.value)}),j.addEventListener("input",e=>{t.l=J(e.target.value)}),k.addEventListener("input",e=>{t.o=e.target.value});